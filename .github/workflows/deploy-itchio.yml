name: Deploy to itch.io

on:
  push:
    branches:
      - main
      - feature/main-cicd-itchio
  workflow_dispatch:

jobs:
  export-and-deploy:
    runs-on: ubuntu-latest
    container: barichello/godot-ci:4.4
    strategy:
      fail-fast: false
      matrix:
        include:
          - preset: Linux/X11
            channel: linux
            output: build/linux/bound-souls.x86_64
          - preset: Windows Desktop
            channel: windows
            output: build/windows/bound-souls.exe
          - preset: Web
            channel: web
            output: build/web/index.html

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install CI tooling
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update
            apt-get install -y curl unzip zip
          elif command -v apk >/dev/null 2>&1; then
            apk add --no-cache curl unzip zip
          elif command -v yum >/dev/null 2>&1; then
            yum install -y curl unzip zip
          else
            echo "No supported package manager found to install curl/unzip/zip"
            exit 1
          fi

      - name: Install Godot export templates
        run: |
          TEMPLATE_VERSION="4.4-stable"
          TEMPLATE_DIR="$HOME/.local/share/godot/export_templates/4.4.stable"
          mkdir -p "$TEMPLATE_DIR" /tmp/godot-templates
          curl -sSL -o /tmp/godot-templates.tpz "https://github.com/godotengine/godot/releases/download/${TEMPLATE_VERSION}/Godot_v${TEMPLATE_VERSION}_export_templates.tpz"
          unzip -q /tmp/godot-templates.tpz -d /tmp/godot-templates
          cp -f /tmp/godot-templates/templates/* "$TEMPLATE_DIR"/
          if [ -f "$TEMPLATE_DIR/web_debug.zip" ] && [ ! -f "$TEMPLATE_DIR/web_nothreads_debug.zip" ]; then
            ln -sf "$TEMPLATE_DIR/web_debug.zip" "$TEMPLATE_DIR/web_nothreads_debug.zip"
          fi
          if [ -f "$TEMPLATE_DIR/web_release.zip" ] && [ ! -f "$TEMPLATE_DIR/web_nothreads_release.zip" ]; then
            ln -sf "$TEMPLATE_DIR/web_release.zip" "$TEMPLATE_DIR/web_nothreads_release.zip"
          fi

      - name: Export game (headless)
        run: |
          mkdir -p "build/${{ matrix.channel }}"
          godot --headless --path . --export-release "${{ matrix.preset }}" "${{ matrix.output }}"

      - name: Zip exported build
        run: |
          cd build
          zip -r "bound-souls-${{ matrix.channel }}.zip" "${{ matrix.channel }}"

      - name: Install butler
        run: |
          curl -sSL -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
          unzip -q butler.zip -d butler
          chmod +x butler/butler

      - name: Upload build to itch.io
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
          ITCHIO_TARGET: ${{ secrets.ITCHIO_USERNAME }}/${{ secrets.ITCHIO_GAME }}:${{ matrix.channel }}
        run: |
          ./build/butler/butler push "build/bound-souls-${{ matrix.channel }}.zip" "$ITCHIO_TARGET"
