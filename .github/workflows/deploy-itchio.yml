name: Deploy to itch.io

on:
  push:
    branches:
      - main
      - feature/main-cicd-itchio
  workflow_dispatch:

jobs:
  export-and-deploy:
    runs-on: ubuntu-latest
    container: barichello/godot-ci:4.4

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install CI tooling
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update
            apt-get install -y curl unzip
          elif command -v apk >/dev/null 2>&1; then
            apk add --no-cache curl unzip
          elif command -v yum >/dev/null 2>&1; then
            yum install -y curl unzip
          else
            echo "No supported package manager found to install curl/unzip"
            exit 1
          fi

      - name: Install Godot export templates
        run: |
          TEMPLATE_VERSION="4.4-stable"
          TEMPLATE_DIR="$HOME/.local/share/godot/export_templates/4.4.stable"
          mkdir -p "$TEMPLATE_DIR" /tmp/godot-templates
          curl -sSL -o /tmp/godot-templates.tpz "https://github.com/godotengine/godot/releases/download/${TEMPLATE_VERSION}/Godot_v${TEMPLATE_VERSION}_export_templates.tpz"
          unzip -q /tmp/godot-templates.tpz -d /tmp/godot-templates
          cp -f /tmp/godot-templates/templates/* "$TEMPLATE_DIR"/
          if [ -f "$TEMPLATE_DIR/web_debug.zip" ] && [ ! -f "$TEMPLATE_DIR/web_nothreads_debug.zip" ]; then
            ln -sf "$TEMPLATE_DIR/web_debug.zip" "$TEMPLATE_DIR/web_nothreads_debug.zip"
          fi
          if [ -f "$TEMPLATE_DIR/web_release.zip" ] && [ ! -f "$TEMPLATE_DIR/web_nothreads_release.zip" ]; then
            ln -sf "$TEMPLATE_DIR/web_release.zip" "$TEMPLATE_DIR/web_nothreads_release.zip"
          fi

      - name: Export game (headless)
        run: |
          mkdir -p build/web
          godot --headless --path . --export-release "Web" build/web/index.html

      - name: Install butler
        run: |
          mkdir -p build/butler
          for url in \
            "https://broth.itch.zone/butler/linux-amd64/LATEST/archive/default" \
            "https://github.com/itchio/butler/releases/latest/download/butler-linux-amd64.zip"
          do
            if curl -fsSL -o /tmp/butler.zip "$url"; then
              break
            fi
          done
          unzip -q /tmp/butler.zip -d build/butler
          chmod +x build/butler/butler

      - name: Upload build to itch.io
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
          ITCHIO_USERNAME: ${{ secrets.ITCHIO_USERNAME }}
          ITCHIO_GAME: ${{ secrets.ITCHIO_GAME }}
          ITCHIO_CHANNEL: html5
        run: |
          username="${ITCHIO_USERNAME}"
          game_raw="${ITCHIO_GAME}"

          game_raw="${game_raw#https://}"
          game_raw="${game_raw#http://}"
          game_raw="${game_raw#www.}"

          if echo "$game_raw" | grep -q "\.itch\.io/"; then
            inferred_user="${game_raw%%.itch.io/*}"
            inferred_game="${game_raw#*.itch.io/}"
            if [ -n "$inferred_user" ]; then
              username="$inferred_user"
            fi
            game_raw="$inferred_game"
          fi

          game_raw="${game_raw#itch.io/}"
          game="${game_raw##*/}"
          game="${game%%\?*}"
          game="${game%%#*}"

          if [ -z "$username" ] || [ -z "$game" ]; then
            echo "::error::Invalid itch secrets. Set ITCHIO_USERNAME (example: yourname) and ITCHIO_GAME (example: bound-souls or full game URL)."
            exit 1
          fi

          ITCHIO_TARGET="${username}/${game}:${ITCHIO_CHANNEL}"
          echo "Using itch target: $ITCHIO_TARGET"
          ./build/butler/butler push "build/web" "$ITCHIO_TARGET"
